---
title: "Gorshkova_DataVis_HW_1"
author: "A. Gorshkova based on the lesson by B.V. Sotnikov"
date: "2024-09-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE, fig.width=16, fig.height=10)

library(tidyverse)
```

## Data reading

```{r dataLoading}
hogwarts <- read_csv("data/hogwarts_2024.csv")
hogwarts |> head()
```

### Checking dataset structure

```{r}
hogwarts |> glimpse()

# Changing some variables type to factors
hogwarts <- hogwarts |> mutate(
  across(c(house, course, sex, wandCore, bloodStatus), ~ as.factor(.x))
)
```


## Задания

# Столбчатые диаграммы


1. Постройте барплот (столбчатую диаграмму), отражающую распределение
числа студентов по курсу обучения. Примените любую из встроенных тем
ggplot. Раскрасьте столбики любым понравившимся вам цветом (можно использовать как словесные обозначения, так и гекскоды). Добавьте цвет
контура столбиков. (1 б)

```{r}

ggplot(hogwarts)+
  geom_bar(aes(x = course, 
               fill = course), 
           colour = "black")+ 
  scale_fill_manual(values = c("1" = "red", "2" = "orange", "3" = "yellow", "4" = "green", "5" = "turquoise2", "6" = "blue", "7" = "violet"))+
  theme_classic()
  
```

> Результат: 1 б.

> Комментарии:

-  Хорошая работа. В целом, на этом графике использовать разные цвета для разных столбиков полезно для отработки навыка, но не для собственно целей визуализации -- столбцов не очень много, и каждый из них отделен друг от друга некоторым интервалом, поэтому дополнительное разделение цветом здесь может быть дублирующим с точки зрения функции. Но отсылка к охотнику на фазанов (или к Жану-звонарю, точная идентификация тут затруднена) зачтена.

-   Здорово, что вы добавляете в пункты задания текстом. Это структурирует документ, и проверять намного удобнее.


2. Создайте новый барплот, отражающий распределение числа студентов
по факультету. Добавьте на график вторую факторную переменную –
происхождение (bloodStatus). Модифицируйте при помощи аргумента
position графика так, чтобы каждый столбец показывал распределение
факультета по чистоте крови в долях. Примените произвольную тему.
Запишите текстом в rmd-документе, какой вывод можно сделать из
графика? (1 б)

```{r}
theme_custom <- theme(
    axis.title.x = element_text(size = 22), 
    axis.title.y = element_text(size = 22),  
    axis.text.x = element_text(size = 14),    
    axis.text.y = element_text(size = 18),    
    legend.title = element_text(size = 22),   
    legend.text = element_text(size = 18),   
    plot.title = element_text(size = 26),  
    panel.background = element_rect(fill='white'),
    panel.grid.major = element_line(color = 'gray60', size = 0.5),  
    panel.grid.minor = element_line(color = 'gray80', size = 0.25),
    
  )

ggplot(hogwarts)+
  geom_bar(aes(x = house, 
               fill = bloodStatus), 
           position = "fill",
           colour = "black")+ 
  scale_fill_manual(values = c("half-blood" = "pink", "muggle-born" = "yellow", "pure-blood" = "turquoise2"))+
  theme_classic()+
  theme_custom
```
Из графика можно сделать вывод, что большинство обучающихся на каждом из курсов Хогвартса - полукровки, а меньшинство - маглорожденные. Есть динамика изменения пропорций, но нет определенного тренда на увеличение или уменьшение доли одной из групп волшебников среди новых наборов.

> Результат: 0.75 б.

> Комментарии:

- Технически все сделано отлично. Не могу не отметить то, что вы пробуете выходить за рамки задания и модифицировать график дополнительно (здесь, например, увеличить шрифт для читаемости и кастомизировать цвета) -- это очень здорово.

- Некоторая неточность в выборе переменной по оси x -- нужно было отобразить на ней не курс, а факультет. Из-за этого и график, и последующая интерпретация рассказывают несколько иную историю.

> Исправлено:

И как обычно, я не справилась с тем, чтобы внимательно прочитать задание... Исправила график!

3. Модифицируйте датасет таким образом, чтобы в нем остались только
чистокровные (pure-blood) и маглорожденные студенты (muggle-born).
Создайте на основе этих данных график из пункта 2. Добавьте
горизонтальную пунктирную линию произвольного цвета на уровне 50%.
Дайте осям название на русском языке (1б). Дополнительно:
переименуйте на русский язык категории легенды pure-blood и
muggle-born (0.5 б).


```{r}

hogwarts |> 
  filter( bloodStatus != "half-blood") |>
  
  ggplot()+
  geom_bar(aes(x = house, 
               fill = bloodStatus), 
           position = "fill",
           colour = "black")+ 
  scale_fill_manual(values = c("muggle-born" = "yellow", "pure-blood" = "turquoise2"),
                    labels = c("muggle-born" = "Маглорожденные", "pure-blood" = "Чистокровные"))+
  geom_hline(yintercept = 0.50, linetype = "dashed", linewidth = 1.5,  color = "red") +
  labs(x = "Факультет", y = "Доля студентов", fill = "Происхождение") +
  theme_custom
```

> Результат: 1.5 б.

> Комментарии:

- Отличный результат. Можно сделать линию, проходящую по 50% отсечке чуть более явной (параметр `linewidth`), но это уже из категории "вкусовщина" и в само задание не входит.

> Исправлено:

Увеличила

# Боксплоты
1. Отобразите распределение баллов, заработанных студентами на 3-й
неделе обучения, по факультетам. Отсортируйте факультеты в порядке
убывания медианного балла за 3-ю неделю (мы не останавливались на
этом в лекции, но упомянутая в ней функция по умолчанию сортирует
именно по медиане, так что в этом случае дополнительных аргументов
передавать не следует). (1 б.)

```{r}
hogwarts |> 
  select(house, week_3)|>
  ggplot()+
  geom_boxplot(aes(x = fct_reorder(house, week_3, .desc = TRUE), y = week_3))+
  labs(x = "Факультет", y = "Оценка за третью неделю") +
  theme_custom

```

> Результат: 1 б.

2. Добавьте отображение разными цветами для происхождения студентов
(bloodStatus). Добавьте на боксплот вырезку (notch). Настройте для
данного чанка размер изображения 14:14 дюймов. Приведите названия
осей к корректному виду. (1 б.)

```{r, fig.width=14, fig.height=14}

hogwarts |> 
  select(house, week_3, bloodStatus)|>
  ggplot()+
  geom_boxplot(aes(x = fct_reorder(house, week_3, .desc = TRUE), y = week_3, fill = bloodStatus), notch = TRUE)+
  scale_fill_manual(values = c("muggle-born" = "yellow", "pure-blood" = "turquoise2", "half-blood" = "pink"),
                    labels = c("muggle-born" = "Маглорожденные", "pure-blood" = "Чистокровные", "half-blood" = "полукровки"))+
  labs(x = "Факультет", y = "Оценки за третью неделю", fill = "Происхождение") +
  theme_custom

```

> Результат: 1 б.

3. Добавьте на график джиттер-плот. Удалите отображение выбросов у
боксплота. Видоизмените по своему вкусу толщину линий и ширину
боксплота. (1 б.) Дополнительно: Добавьте название графика и подпись
(0.5 б.)

```{r, fig.width=14, fig.height=14}

hogwarts |> 
  select(house, week_3, bloodStatus) |>
  ggplot() +
  

  geom_boxplot(aes(x = fct_reorder(house, week_3, .desc = TRUE), y = week_3, fill = bloodStatus), 
               notch = TRUE, 
               outlier.shape = NA,
               size = 1.2, 
               width = 0.6  
  ) +
  geom_jitter(aes(x = fct_reorder(house, week_3, .desc = TRUE), y = week_3),
              width = 0.15, height = 0, size = 2) +
  scale_fill_manual(values = c("muggle-born" = "yellow", "pure-blood" = "turquoise2", "half-blood" = "pink"),
                    labels = c("muggle-born" = "Маглорожденные", "pure-blood" = "Чистокровные", "half-blood" = "Полукровки")) +
  labs(
    title = "Оценки студентов Хогвартса за третью неделю",
    subtitle = "Распределение оценок по факультетам и происхождению студентов",
    x = "Факультет", 
    y = "Оценки за третью неделю", 
    fill = "Происхождение", 
    color = "Происхождение"
  ) +

  theme_classic() +
  theme_custom
```

> Результат: 1.25 б.

> Комментарии:

- Хорошая работа, есть пара нюансов.

- Подпись обычно кодируется как `caption` и по умолчанию находится в правом нижнем углу и содержит информацию о, например, источнике данных. Subtitle -- это подзаголовок, у него обычно несколько иные функции (расширяет и дополняет значение заголовка).

- Это не было прописано в тексте задания, но заголовок и подзаголовок лучше центрировать по ширине (можно прописать это в теме, например так: `plot.title = element.text(hjust = 0.5)`).

- Скорее придирка, чем реальное замечание -- при работе с линиями толщину по конвенции лучше задавать через аргумент `linewidth`, а не через `size` (хотя последний тоже работает).

- Еще одно замечание чисто стилистического характера, теперь уже даже не про датавиз -- в конвеерных конструкциях с пайпами и плюсами конструкциях лучше не добавлять пустых строк. Если вы хотите разделить код на смысловые блоки, лучше вставить между ними комментарии.

# Разное

1. Постройте “леденцовый график” (lollipop-plot) для количества набранных
студентами 5-го курса баллов за весь учебный год (по оси ординат – id
студента, по оси абсцисс – итоговый балл). Отсортируйте студентов в
порядке убывания. Раскрасьте точки на “леденцах” в зависимости от
сердцевины волшебной палочки. Палочки с сердечной жилой дракона
должны быть красного цвета, с пером феникса – желтого, с волосом
единорога – серого. (1 б.)



```{r}
hogwarts |> 
  filter(course == "5") |> 
  mutate(id = as.factor(id)) |> 
  ggplot()+
  geom_segment(aes(x = fct_reorder(id, result, .desc = TRUE), xend = id, y = 0, yend = result))+
  geom_point(aes(x = id, y = result, color = wandCore))+
  scale_color_manual(values = c("dragon heartstring" = "red", "phoenix feather" = "yellow2", "unicorn hair" = "gray50"),
                    labels = c("dragon heartstring" = "Жила дракона", "phoenix feather" = "Перо феникса", "unicorn hair" = "Волос единорога")) +
  
  labs(
    title = "Оценки пятикурсников Хогвартса за весь учебный год",
    x = "Студент", 
    y = "Оценки за учебный год", 
    fill = "Материал палочки", 
    color = "Материал палочки"
  ) +
  
  theme_classic()+
  theme(
    axis.title.x = element_text(size = 22), 
    axis.title.y = element_text(size = 22),  
    axis.text.x = element_text(size = 14),    
    axis.text.y = element_text(size = 0),    
    legend.title = element_text(size = 22),   
    legend.text = element_text(size = 20),   
    plot.title = element_text(size = 26),  
  )+
  coord_flip()
```

> Результат: 1 б.

> Комментарии:

- Все здорово, но здесь стоило поменять оси местами -- на y отобразить id, а на x -- балл. Если хочется быстро развернуть оси, не переписывая код, можно использовать `coord_flip()`. Но злоупотреблять этой опцией не стоит -- оси меняются только визуально, поэтому если после трансформации захочется что-то изменить, то нужно будет держать в голове, что ось, отображаемую как x, мы прописываем как y; а y как x.

- Из категории вкусовщины -- я бы сделал точки чуть крупнее.

> Исправления:

Спасибо, оси исправлены!

2. Постройте гистограмму распредления баллов за экзамен по астрономии.
Выделите цветом факультет Слизерин. Примените 18-й кегль к тексту на
осях x, y и легенды. Название оси y и легенды запишите 20-м кеглем, оси x
– 22-м. Измените название оси y на “Number of students”. (1 б.)

```{r}

ggplot()+
  geom_histogram(data = hogwarts, aes(x = `Astronomy exam`, fill = house == "Slytherin"), color = "black", alpha=0.6)+
  scale_fill_manual(values = c("FALSE" = "red", "TRUE" = "#1F5D25"), 
                    labels = c("FALSE" = "Другие факультеты", "TRUE" = "Слизерин")) +
  labs(
    title = "Баллы за экзамен по астрономии", 
    y = "Number of students", 
    fill = "Факультет", 
    color = "Факультет"
  ) +
  theme_classic()+
   theme(
    axis.title.x = element_text(size = 22), 
    axis.title.y = element_text(size = 20),  
    axis.text.x = element_text(size = 18),    
    axis.text.y = element_text(size = 18),    
    legend.title = element_text(size = 20),   
    legend.text = element_text(size = 18),   
    plot.title = element_text(size = 25),  
  )
```

> Результат: 1 б.

> Комментарии:

-  Хороший график и хорошая же дополнительная работа с легендой!

-  Небольшой момент -- лучше делать текст заголовка крупнее, чем текст осей (как на предыдущих графиках).

3. На лекции мы использовали комбинацию theme_bw(), и созданной нами
theme_custom, чтобы одновременно сделать фон белым и увеличить
шрифт. Модифицируйте theme_custom таким образом, чтобы она и
выполняла свои прежние функции, и делала фон белым без помощи
theme_bw(). Примените новую кастомную тему к графику, полученному в
последнем пункте блока по боксплотам (1.5 б).


```{r, fig.width=14, fig.height=14}

theme_custom <- theme(
    axis.title.x = element_text(size = 22), 
    axis.title.y = element_text(size = 22),  
    axis.text.x = element_text(size = 18),    
    axis.text.y = element_text(size = 18),    
    legend.title = element_text(size = 22),   
    legend.text = element_text(size = 18),   
    plot.title = element_text(size = 26),  
    panel.background = element_rect(fill='white'),
    panel.grid.major = element_line(color = 'gray30', size = 0.5),  
    panel.grid.minor = element_line(color = 'gray80', size = 0.25),
    
  )

hogwarts |> 
  select(house, week_3, bloodStatus) |>
  ggplot() +
  
  geom_boxplot(aes(x = fct_reorder(house, week_3, .desc = TRUE), y = week_3, fill = bloodStatus), 
               notch = TRUE, 
               outlier.shape = NA,
               size = 1.2, 
               width = 0.6  
  ) +
  geom_jitter(aes(x = fct_reorder(house, week_3, .desc = TRUE), y = week_3),
              width = 0.15, height = 0, size = 2) +
  scale_fill_manual(values = c("muggle-born" = "yellow", "pure-blood" = "turquoise2", "half-blood" = "pink"),
                    labels = c("muggle-born" = "Маглорожденные", "pure-blood" = "Чистокровные", "half-blood" = "Полукровки")) +
  labs(
    title = "Оценки студентов Хогвартса за третью неделю",
    subtitle = "Распределение оценок по факультетам и происхождению студентов",
    x = "Факультет", 
    y = "Оценки за третью неделю", 
    fill = "Происхождение", 
    color = "Происхождение"
  ) +
  theme_custom
```

> Результат: 1.5 б.

> Комментарии:

-  Здесь все здорово, но можно было использовать чуть более "ленивый" способ -- сохранить в переменную график из пункта 2.3 (для чистоты эксперимента можно было при этом закомментировать `theme_bw()`), и просто добавить к переменной в этом чанке новую тему.

# Фасетирование

1. Напишите, какой, по вашему мнению, способ фасетирования (по строкам
или по столбцам) лучше использовать для визуализации гистограммы.
Почему? А какой для визуализации violin-plot? Почему? Можно ли
вывести общее правило?


**Гистограммы**, на мой личный вкус, лучше фасетировать по столбцам, чтобы лучше видеть различия по ширине и форме распределений.

Кому-то может больше понравится фасетирование по строкам, чтобы все столбцы были один под другим и было удобнее сравнивать высоту одних и тех же столбиков. Но чисто визуально мне так не нравится.

Для **вайолин плот** фасетирование по столбцам выглядит лучше, так как удобнее сравнивать ширину виолончелей (количество значений для одинаковых y). Фасетирование по столбцам делает сравнение более естественным, поскольку виолончели располагаются горизонтально и их проще сопоставить по ширине и форме.


**В целом мое мнение:**

1. На мой взгяд, способ фасетирования для графиков зависит от количества категорий, 
а также фасетирование не должно искажать пропорции графика и стирать отличия между значениями.

2. Фасетирование по строкам лучше подходит, если категорий до 4-5, а фасетирование по столбцам более эффективно, если категорий больше.

3. Горизонтальные сравнения (когда смотрим слева направо) более естественны для человеческого восприятия.

**Общее правило:**
Все правила визуализации должны быть гибкими в зависимости от типа данных и цели визуализации.

> Результат: 1 б.

> Комментарии:

- Мне очень понравилось последнее замечание про "зависит от" это правда часто так.

- Полностью согласен с пунктом про вайолин плот. Насчет гистограмм -- я скорее отношусь ко второй категории, потому что при отображении по строкам, действительно, как вы упомянули, можно сравнить как отличаются распределения в каждой конкретной точке.

- Если категорий слишком много, я бы предпочел их "укладывать" по обеим осям сразу, потому что слишком вытянутый график по любой из осей читается сильно тяжелее.

- Резюмируя -- прекрасный развернутый ответ. Отдельное спасибо за маркдаун в оформлении.

2. Постройте гистограмму для результата любого выбранного вами
экзамена, кроме зельеварения. Настройте оптимальное на ваш взгляд
число столбцов гистограммы. Выполните фасетирование по курсу.
Постарайтесь, чтобы график был по возможности компактным.

Оптимальная ширина столбца была выбрана по правилу Фридмана-Дьякониса, согласно его формуле
ширина столбца = 2 * IQR/ n^(1/3) , где IQR - интерквартильный размах, а n - количество случаев

```{r}

fd_binwidth <- function(x) {
  IQR_x <- IQR(x) 
  n <- length(x)   
  binwidth <- 2 * IQR_x / n^(1/3)
  return(binwidth)
}
optimal_binwidth <- fd_binwidth(hogwarts$`Care of magical creatures exam`)

ggplot(hogwarts)+
  geom_histogram(aes(x = `Care of magical creatures exam`), 
                 fill = "turquoise2", 
                 colour = "grey49",
                 binwidth = optimal_binwidth
 )+
  theme_custom+
  theme(strip.text = element_text(size = 15))
```



**Фасетирование по курсу**

Ширина столбца увеличена и подобрана вручную, так как в каждой гистограмме стало меньше наблюдений, 
и это число не равно для всех трех графиков

```{r}
ggplot(hogwarts)+
  geom_histogram(aes(x = `Care of magical creatures exam`), 
                 fill = "turquoise2", 
                 colour = "grey49", 
                 binwidth = 10)+
  facet_wrap(vars(course))+
  theme_bw()+
  theme_custom+
  theme(strip.text = element_text(size = 15))
```

> Результат: 1 б.

> Комментарии:

- Отличная работа, и отдельное спасибо за Формулу Фридмана-Дьякониса. На лекции был другой подход к автоматизированному подбору числа бинов, и ваш мне нравится больше.


3. Отобразите на одном графике распределение плотности вероятности для
оценки студентов на экзамене по защите от темных искусств и на
экзамене по травологии. Раскрасьте их в любые выбранные вами цвета,
постарайтесь, чтобы оба распределения отображались целиком.
Примените тему из 3-го пункта блока “Разное”. Сделайте фасетирование
по полу.

```{r}
ggplot(hogwarts)+
  geom_density(aes(x = `Herbology exam`, 
               fill = "Herbology", 
               colour = "Herbology"),
               alpha = 0.5)+
  geom_density(aes(x = `Defence against the dark arts exam`, 
               fill = "Defence against the dark arts", 
               colour = "Defence against the dark arts"),
               alpha = 0.5)+
  facet_wrap(vars(sex))+
  scale_fill_manual(name = "Экзамен", 
                    values = c("Herbology" = "turquoise1", "Defence against the dark arts" = "yellow")) +
  scale_colour_manual(name = "Экзамен", 
                      values = c("Herbology" = "grey49", "Defence against the dark arts" = "grey49")) +
  theme_bw()+
  theme_custom
```

> Результат: 1 б.

> Комментарии:

- Все хорошо. Комментарии ниже скорее стилистического толка и никак не влияют на баллы.

- Я бы, возможно, выбрал чуть менее контрастные цвета и/или более жирные сплошные линии. В текущем подходе из-за наложения цветов и не очень акцентированных контуров может показаться, что распределений три (желтое, зеленое и синее).

- Можно было использовать только новую кастомную тему без `theme_bw()` (применение двух тем -- скорее, "костыль", который мы использовали на лекции, чтобы не закапываться в нюансы ручной темы слишком рано, но и не оставлять дефолтный серый фон).

- По поводу фасетирования -- продублирую мысль из обсуждения заданий 4.1: лучше в случае, когда основная информация расположена вдоль оси X, делать его по строкам

> Итоговый результат: 12.25 + 0.5 + 0.25 + 1 = 14 б.

> Итоговый комментарий:

Хорошая работа. Здорово, что вы эксериментируете и пробуете вещи, которые выходят за рамки конкретного задания (а иногда и за рамки лекционного материала). Отлично, что вы подробно и аргументируете расписываете свою точку зрения. Добавил по 0.5 балла за общее впечатление о графике и за Фридмана-Дьякониса.
